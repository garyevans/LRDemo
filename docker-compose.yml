services:
  # -----------------------------
  # PG16 conflict handling demo
  # -----------------------------
  pg16_a:
    image: postgres:16
    container_name: pg16_a
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: demo
      # Demo-only convenience so logical replication can connect without editing pg_hba.conf
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "54161:5432"
    command:
      - "postgres"
      - "-c"  # logical replication prereqs
      - "wal_level=logical"
      - "-c"
      - "max_wal_senders=10"
      - "-c"
      - "max_replication_slots=10"
      - "-c"
      - "max_logical_replication_workers=10"
      - "-c"
      - "max_worker_processes=20"
      - "-c"
      - "listen_addresses=*"
      - "-c"
      - "log_line_prefix=[%m][%p][%a][%u][%d]"
      - "-c"
      - "log_replication_commands=on"
    volumes:
      - pg16_a_data:/var/lib/postgresql/data
      - ./init/pg16_a_init:/docker-entrypoint-initdb.d:ro
      - ./init/pg16_a_demo:/demo:rw
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d demo"]
      interval: 2s
      timeout: 3s
      retries: 30

  pg16_b:
    image: postgres:16
    container_name: pg16_b
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: demo
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "54162:5432"
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"
      - "-c"
      - "max_wal_senders=10"
      - "-c"
      - "max_replication_slots=10"
      - "-c"
      - "max_logical_replication_workers=10"
      - "-c"
      - "max_worker_processes=20"
      - "-c"
      - "listen_addresses=*"
      - "-c"
      - "log_line_prefix=[%m][%p][%a][%u][%d]"
      - "-c"
      - "log_replication_commands=on"
    volumes:
      - pg16_b_data:/var/lib/postgresql/data
      - ./init/pg16_b_init:/docker-entrypoint-initdb.d:ro
      - ./init/pg16_b_demo:/demo:rw
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d demo"]
      interval: 2s
      timeout: 3s
      retries: 30

  # -----------------------------
  # PG18 conflict handling demo
  # -----------------------------
  pg18_a:
    image: postgres:18
    container_name: pg18_a
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: demo
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "54181:5432"
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"
      - "-c"
      - "max_wal_senders=10"
      - "-c"
      - "max_replication_slots=10"
      - "-c"
      - "max_logical_replication_workers=10"
      - "-c"
      - "max_worker_processes=20"
      - "-c"
      - "listen_addresses=*"
      - "-c"
      - "log_line_prefix=[%m][%p][%a][%u][%d]"
      - "-c"
      - "log_replication_commands=on"
    volumes:
      # PG18+ official image volume location changed; mount higher-level dir (see note above)
      - pg18_a_data:/var/lib/postgresql
      - ./init/pg18_a_init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d demo"]
      interval: 2s
      timeout: 3s
      retries: 30

  pg18_b:
    image: postgres:18
    container_name: pg18_b
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: demo
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "54182:5432"
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"
      - "-c"
      - "max_wal_senders=10"
      - "-c"
      - "max_replication_slots=10"
      - "-c"
      - "max_logical_replication_workers=10"
      - "-c"
      - "max_worker_processes=20"
      - "-c"
      - "listen_addresses=*"
      - "-c"
      - "log_line_prefix=[%m][%p][%a][%u][%d]"
      - "-c"
      - "log_replication_commands=on"
    volumes:
      - pg18_b_data:/var/lib/postgresql
      - ./init/pg18_b_init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d demo"]
      interval: 2s
      timeout: 3s
      retries: 30


    
volumes:
  pg16_a_data:
  pg16_b_data:
  pg18_a_data:
  pg18_b_data:
